{% extends 'layout.html' %} 

{% block title %}HZW.GM.User{%endblock%} 

{% block head %}
    <!-- Bootstrap-table-1.8.1 -->
    <link rel="stylesheet" href="../plugins/bootstrap-table-1.8.1-dist/bootstrap-table.min.css">
{% endblock %} 

{% block body %}class="hold-transition skin-blue sidebar-collapse sidebar-mini"{%endblock%} 

{% block content %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
        用户管理
        <small>查找用户进行修改</small>
      </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> 首页</a></li>
            <li>GM管理工具</li>
            <li class="active">用户管理</li>
        </ol>
    </section>

    <!-- Main content -->
    <section class="content">

        <!-- Your Page Content Here -->
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-info">                                     
                    <div id="toolbar_account"></div>
                    <div class="box-body">
                        <table id="table_account" 
                            data-toolbar="#toolbar_account" 
                            data-search="true" 
                            data-show-refresh="true" 
                            data-show-toggle="true" 
                            data-show-columns="true"
                            data-show-export="false" 
                            data-detail-view="false"
                            data-minimum-count-columns="2"
                            data-show-pagination-switch="true" 
                            data-pagination="true" 
                            data-id-field="id" 
                            data-page-list="[10, 25, 50, 100, ALL]"
                            data-show-footer="false" 
                            data-side-pagination="server" 
                            data-url="../Rest/Tables/Account"></table>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.row -->
    </section>
    <!-- /.content -->
</div>
<!-- /.content-wrapper -->
{% endblock %} 

{% block script %}
    <!-- AdminLTE App -->
    <script src="../plugins/AdminLTE-2.3.0-dist/js/app.min.js"></script>
    <!-- Bootstrap-table-1.8.1 -->
    <script type="text/javascript" src="../plugins/bootstrap-table-1.8.1-dist/bootstrap-table.min.js"></script>
    <script type="text/javascript" src="../plugins/bootstrap-table-1.8.1-dist/bootstrap-table-zh-CN.min.js"></script>
    <script>
        var $table = $('#table_account');

        $(function () {
            $.ajax({
                type: "GET",
                url: "../Rest/Schemas/Account",
                success: function (data) {
                    var pTable = data;
                    var pColumns =[];
                    for(var i=0;i<pTable.Fields.length;i++){
                        var pField = pTable.Fields[i];
                        pColumns.push({
                        title: pField.Alias,
                        field: pField.Name,
                        align: 'center',
                        valign: 'middle',
                        sortable: true,
                        });
                    }
                    pColumns.push({
                        field: 'operate', 
                        title: '操作', 
                        align: 'center', 
                        events: operateEvents, 
                        formatter: operateFormatter
                    });
                    $table.bootstrapTable({
                        sortName: 'Id',
                        sortOrder: 'asc',
                        columns: pColumns
                    });
                    $table.on('check.bs.table uncheck.bs.table ' +
                            'check-all.bs.table uncheck-all.bs.table', function () {
                                $remove.prop('disabled', !$table.bootstrapTable('getSelections').length);
                                selections = getIdSelections();
                            });
                    }
                });
        });

        function getIdSelections() {
            return $.map($table.bootstrapTable('getSelections'), function (row) {
                return row.UserId
            });
        }

        function responseHandler(res) {
            $.each(res.rows, function (i, row) {
                row.state = $.inArray(row.id, selections) !== -1;
            });
            return res;
        }

        function detailFormatter(index, row) {
            var html = [];
            $.each(row, function (key, value) {
                html.push('<p><b>' + key + ':</b> ' + value + '</p>');
            });
            return html.join('');
        }

        function UserIdFormatter(value, row, index) {
            return [
                '<a class="link" title="编辑" href="' + 'Contents/UserEdit.html?UserId=' + row.UserId + '">',
                row.UserId,
                '</a>'
            ].join('');
        }

        function operateFormatter(value, row, index) {
            return [
                '<a class="knight" title="定岗" href="javascript:void(0)">',
                '<i class="glyphicon glyphicon-knight"></i>',
                '</a>  ',
                '<a class="edit" title="编辑" href="javascript:void(0)">',
                '<i class="glyphicon glyphicon-edit"></i>',
                '</a>  ',
                '<a class="remove" title="删除" href="javascript:void(0)">',
                '<i class="glyphicon glyphicon-remove"></i>',
                '</a>'
            ].join('');
        }

        window.operateEvents = {
            'click .knight': function (e, value, row, index) {
                var sHerf = "Contents/UserInPost.html?UserId=" + row.UserId + "&Ssdwbs=" + row.Ssdwbs;
                window.parent.onNavigation(sHerf, e);
            },
            'click .edit': function (e, value, row, index) {
                var sHerf = "Contents/UserEdit.html?UserId=" + row.UserId;
                window.parent.onNavigation(sHerf, e);
            },
            'click .remove': function (e, value, row, index) {
                var pDelete_Userid = row.UserId;
                var ids = [];
                ids.push(pDelete_Userid);
                onDelete(ids);
            }
        };

        function totalTextFormatter(data) {
            return 'Total';
        }

        function totalNameFormatter(data) {
            return data.length;
        }

        function totalPriceFormatter(data) {
            var total = 0;
            $.each(data, function (i, row) {
                total += +(row.price.substring(1));
            });
            return '$' + total;
        }

        function onDelete(ids) {
            $("#p_loadingstate").css('display', 'block');

            var pDeleteObject = {};
            for (var i = 0; i < ids.length; i++) {
                pDeleteObject[ids[i]] = {}
            }

            $.ajax({
                type: "POST",
                url: "../Rest/Services/User/Delete",
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json; charset=utf-8"
                },
                data: JSON.stringify(pDeleteObject),
                success: function (data) {
                    $("#p_loadingstate").css('display', 'none');
                    if (data.success) {
                        $table.bootstrapTable('remove', {
                            field: 'UserId',
                            values: ids
                        });
                        $remove.prop('disabled', true);
                    }
                }
            });
        }

        function getHeight() {
            return $(window).height()  - 145;
        }
    </script>
{% endblock %}